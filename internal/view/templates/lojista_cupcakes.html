<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerenciar Cupcakes - Lojista</title>
    <link rel="stylesheet" href="/static/css/style.css" />
    <style>
      .container {
        max-width: 1000px;
        margin: 2rem auto;
        padding: 0 1rem;
        box-sizing: border-box;
      }
      h1 {
        text-align: left;
        color: #333;
      }
      .header-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }
      .header-actions button {
        cursor: pointer;
        flex-shrink: 0;
      }

      /* --- Estilos da Tabela Responsiva --- */
      .table-responsive-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        width: 100%;
        margin-bottom: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        background-color: white;
      }
      .cupcakes-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
      }
      .cupcakes-table th,
      .cupcakes-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #ddd;
        text-align: left;
        vertical-align: middle;
      }
      .cupcakes-table thead th {
        background-color: #f7f7f7;
        font-weight: bold;
      }
      .cupcakes-table tbody tr:hover {
        background-color: #f1f1f1;
      }
      .cupcake-img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 5px;
      }
      .actions a {
        text-decoration: none;
        margin-right: 10px;
        color: #007bff;
        font-weight: bold;
        cursor: pointer;
      }
      .actions a.delete {
        color: #dc3545;
      }
      .empty-state {
        text-align: center;
        padding: 40px;
        color: #777;
      }

      /* --- Estilos do Modal de Formulário --- */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-content {
        background-color: white;
        padding: 2rem;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        position: relative;
        box-sizing: border-box;
      }
      .modal-content h2 {
        color: #ff69b4;
        margin-top: 0;
      }
      .close-btn {
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 2rem;
        color: #aaa;
        cursor: pointer;
        border: none;
        background: none;
      }
      .form-group {
        margin-bottom: 1rem;
      }
      label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: bold;
      }
      input[type="text"],
      input[type="number"],
      textarea,
      input[type="file"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      textarea {
        resize: vertical;
        min-height: 80px;
      }
      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 1.5rem;
      }
      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .checkbox-group input {
        width: auto;
      }
      .checkbox-group label {
        margin-bottom: 0;
        font-weight: normal;
      }

      /* --- CSS PARA O MODAL DE CONFIRMAÇÃO --- */
      .confirm-modal .modal-content {
        max-width: 400px; /* Modal menor */
        text-align: center;
      }
      .confirm-modal h3 {
        color: #333;
        margin-top: 0;
      }
      .confirm-modal p {
        color: #555;
        margin-bottom: 1.5rem;
      }
      .confirm-actions {
        display: flex;
        justify-content: center;
        gap: 1rem;
      }
      .confirm-actions .btn-danger {
        background-color: #dc3545;
        border-color: #dc3545;
        color: white;
      }
      .confirm-actions .btn-danger:hover {
        background-color: #c82333;
        border-color: #bd2130;
      }
      /* --- FIM CSS MODAL CONFIRMAÇÃO --- */

      @media (max-width: 768px) {
        .container {
          margin: 1rem auto;
        }
        .header-actions {
          flex-direction: column;
          align-items: stretch;
          gap: 1rem;
        }
        .header-actions h1 {
          text-align: center;
          font-size: 1.8rem;
          margin-bottom: 0;
        }
        .header-actions button {
          width: 100%;
          box-sizing: border-box;
        }
        .modal-content {
          padding: 1.5rem;
          width: 95%;
          max-height: 90vh;
          overflow-y: auto;
        }
        .confirm-actions {
          flex-direction: column;
        } /* Empilha botões no mobile */
        .confirm-actions .btn {
          width: 100%;
          box-sizing: border-box;
        }
      }
    </style>
  </head>
  <body>
    {{ template "_header.html" . }}

    <div class="container">
      <div class="header-actions">
        <h1>Gerenciar Cupcakes</h1>
        <button id="addCupcakeBtn" class="btn btn-primary">
          Adicionar Novo Cupcake
        </button>
      </div>

      <div class="table-responsive-wrapper">
        <table class="cupcakes-table">
          <thead>
            <tr>
              <th>Imagem</th>
              <th>Nome</th>
              <th>Preço</th>
              <th>Disponível</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            {{ range .Cupcakes }}
            <tr
              data-id="{{ .ID }}"
              data-name="{{ .Nome }}"
              data-description="{{ .Descricao }}"
              data-price="{{ .Preco }}"
              data-available="{{ .Disponivel }}"
              data-image="{{ .ImagemURL }}"
            >
              <td>
                <img
                  src="{{ .ImagemURL }}"
                  alt="{{ .Nome }}"
                  class="cupcake-img"
                />
              </td>
              <td>{{ .Nome }}</td>
              <td>R$ {{ printf "%.2f" .Preco }}</td>
              <td>{{ if .Disponivel }} Sim {{ else }} Não {{ end }}</td>
              <td class="actions">
                <a class="edit-btn">Editar</a>
                <a href="/lojista/cupcakes/excluir/{{ .ID }}" class="delete"
                  >Excluir</a
                >
              </td>
            </tr>
            {{ else }}
            <tr>
              <td colspan="5" class="empty-state">
                Nenhum cupcake cadastrado ainda.
              </td>
            </tr>
            {{ end }}
          </tbody>
        </table>
      </div>
    </div>

    <div class="modal-overlay" id="cupcakeModal">
      <div class="modal-content">
        <button class="close-btn" id="closeModalBtn">&times;</button>
        <h2 id="modalTitle">Adicionar Novo Cupcake</h2>
        <form id="cupcakeForm" method="POST" enctype="multipart/form-data">
          <div class="form-group">
            <label for="nome">Nome</label>
            <input type="text" id="nome" name="nome" required />
          </div>
          <div class="form-group">
            <label for="descricao">Descrição</label>
            <textarea
              id="descricao"
              name="descricao"
              rows="4"
              required
            ></textarea>
          </div>
          <div class="form-group">
            <label for="preco">Preço (R$)</label>
            <input
              type="number"
              id="preco"
              name="preco"
              step="0.01"
              min="0"
              required
            />
          </div>
          <div class="form-group">
            <label for="imagem">Foto (opcional ao editar)</label>
            <input
              type="file"
              id="imagem"
              name="imagem"
              accept="image/png, image/jpeg"
            />
          </div>
          <div class="form-group checkbox-group">
            <input
              type="checkbox"
              id="disponivel"
              name="disponivel"
              value="true"
            />
            <label for="disponivel">Disponível para venda</label>
          </div>
          <div class="form-actions">
            <button type="button" id="cancelBtn" class="btn btn-secondary">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">Salvar</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal-overlay confirm-modal" id="deleteConfirmModal">
      <div class="modal-content">
        <button class="close-btn" id="cancelDeleteBtn">&times;</button>
        <h3>Confirmar Exclusão</h3>
        <p id="deleteModalText">Tem certeza que deseja excluir este cupcake?</p>
        <div class="confirm-actions">
          <button id="cancelDeleteBtn2" class="btn btn-secondary">
            Cancelar
          </button>
          <a href="#" id="deleteConfirmBtn" class="btn btn-danger">Excluir</a>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        console.log("Script lojista_cupcakes.html carregado.");
        const modalOverlay = document.getElementById("cupcakeModal");
        const addBtn = document.getElementById("addCupcakeBtn");
        const closeBtn = document.getElementById("closeModalBtn");
        const cancelBtn = document.getElementById("cancelBtn");
        const editBtns = document.querySelectorAll(".edit-btn");

        const form = document.getElementById("cupcakeForm");
        const modalTitle = document.getElementById("modalTitle");

        const openModal = () => {
          console.log("Abrindo modal de formulário...");
          modalOverlay.style.display = "flex";
        };
        const closeModal = () => {
          console.log("Fechando modal de formulário...");
          modalOverlay.style.display = "none";
        };

        if (addBtn) {
          console.log("Botão 'Adicionar' encontrado.");
          addBtn.addEventListener("click", () => {
            console.log("Botão 'Adicionar' clicado!");
            modalTitle.textContent = "Adicionar Novo Cupcake";
            form.action = "/lojista/cupcakes/novo";
            form.reset();
            document.getElementById("imagem").required = true;
            openModal();
          });
        } else {
          console.error("Botão 'addCupcakeBtn' não encontrado!");
        }

        editBtns.forEach((btn) => {
          btn.addEventListener("click", (e) => {
            console.log("Botão 'Editar' clicado!");
            e.preventDefault();

            const row = e.target.closest("tr");
            const id = row.dataset.id;
            if (!id) {
              console.error("data-id não encontrado na linha!");
              return;
            }

            modalTitle.textContent = "Editar Cupcake";
            form.action = `/lojista/cupcakes/editar/${id}`;

            form.nome.value = row.dataset.name || "";
            form.descricao.value = row.dataset.description || "";
            form.preco.value = row.dataset.price || "";
            form.disponivel.checked = row.dataset.available === "true";
            document.getElementById("imagem").required = false;
            document.getElementById("imagem").value = "";

            openModal();
          });
        });

        if (closeBtn) closeBtn.addEventListener("click", closeModal);
        if (cancelBtn) cancelBtn.addEventListener("click", closeModal);
        if (modalOverlay)
          modalOverlay.addEventListener("click", (e) => {
            if (e.target === modalOverlay) closeModal();
          });

        // --- LÓGICA PARA O MODAL DE EXCLUSÃO ---
        const deleteModal = document.getElementById("deleteConfirmModal");
        const deleteLinks = document.querySelectorAll("a.delete");
        const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
        const cancelDeleteBtn2 = document.getElementById("cancelDeleteBtn2");
        const deleteConfirmBtn = document.getElementById("deleteConfirmBtn");
        const deleteModalText = document.getElementById("deleteModalText");

        if (deleteModal) {
          // Garante que o modal existe
          const openDeleteModal = () => {
            console.log("Abrindo modal de exclusão...");
            deleteModal.style.display = "flex";
          };
          const closeDeleteModal = () => {
            console.log("Fechando modal de exclusão...");
            deleteModal.style.display = "none";
          };

          deleteLinks.forEach((link) => {
            link.addEventListener("click", (e) => {
              console.log("Link 'Excluir' clicado!");
              e.preventDefault(); // Impede a navegação

              const deleteUrl = e.currentTarget.getAttribute("href");
              const row = e.target.closest("tr");
              const cupcakeName = row.dataset.name || "este item";

              deleteModalText.textContent = `Tem certeza que deseja excluir o cupcake "${cupcakeName}"? Esta ação não pode ser desfeita.`;
              deleteConfirmBtn.setAttribute("href", deleteUrl);

              openDeleteModal();
            });
          });

          if (cancelDeleteBtn)
            cancelDeleteBtn.addEventListener("click", closeDeleteModal);
          if (cancelDeleteBtn2)
            cancelDeleteBtn2.addEventListener("click", closeDeleteModal);
          deleteModal.addEventListener("click", (e) => {
            if (e.target === deleteModal) closeDeleteModal();
          });
        } else {
          console.error(
            "Modal de confirmação 'deleteConfirmModal' não encontrado!"
          );
        }
      });
    </script>
  </body>
</html>
