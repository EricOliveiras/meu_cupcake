<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerenciar Cupcakes - Lojista</title>
    <link rel="stylesheet" href="/static/css/style.css" />
    <style>
      .container {
        max-width: 1000px;
        margin: 2rem auto;
      }
      h1 {
        text-align: left;
        color: #333;
      } /* Ajuste cor H1 */
      .header-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }
      .header-actions button {
        cursor: pointer;
      } /* Garante cursor no botão */

      .cupcakes-table {
        width: 100%;
        border-collapse: collapse;
        background-color: white;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        overflow: hidden;
      }
      .cupcakes-table th,
      .cupcakes-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #ddd;
        text-align: left;
        vertical-align: middle;
      }
      .cupcakes-table thead th {
        background-color: #f7f7f7;
        font-weight: bold;
      }
      .cupcakes-table tbody tr:hover {
        background-color: #f1f1f1;
      }
      .cupcake-img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 5px;
      }
      .actions a {
        text-decoration: none;
        margin-right: 10px;
        color: #007bff;
        font-weight: bold;
        cursor: pointer;
      }
      .actions a.delete {
        color: #dc3545;
      }
      .empty-state {
        text-align: center;
        padding: 40px;
        color: #777;
      }

      /* --- ESTILOS DO MODAL --- */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-content {
        background-color: white;
        padding: 2rem;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        position: relative;
      }
      .modal-content h2 {
        color: #ff69b4;
        margin-top: 0;
      }
      .close-btn {
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 2rem;
        color: #aaa;
        cursor: pointer;
        border: none;
        background: none;
      }
      .form-group {
        margin-bottom: 1rem;
      }
      label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: bold;
      }
      input[type="text"],
      input[type="number"],
      textarea,
      input[type="file"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      textarea {
        resize: vertical;
        min-height: 80px;
      } /* Ajuste altura textarea */
      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 1.5rem;
      }
      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .checkbox-group input {
        width: auto;
      }
      .checkbox-group label {
        margin-bottom: 0;
        font-weight: normal;
      } /* Ajuste label checkbox */
    </style>
  </head>
  <body>
    {{ template "_header.html" . }}

    <div class="container">
      <div class="header-actions">
        <h1>Gerenciar Cupcakes</h1>
        <button id="addCupcakeBtn" class="btn btn-primary">
          Adicionar Novo Cupcake
        </button>
      </div>

      <table class="cupcakes-table">
        <thead>
          <tr>
            <th>Imagem</th>
            <th>Nome</th>
            <th>Preço</th>
            <th>Disponível</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          {{ range .Cupcakes }}
          <tr
            data-id="{{ .ID }}"
            data-name="{{ .Nome }}"
            data-description="{{ .Descricao }}"
            data-price="{{ .Preco }}"
            data-available="{{ .Disponivel }}"
            data-image="{{ .ImagemURL }}"
          >
            <td>
              <img
                src="{{ .ImagemURL }}"
                alt="{{ .Nome }}"
                class="cupcake-img"
              />
            </td>
            <td>{{ .Nome }}</td>
            <td>R$ {{ printf "%.2f" .Preco }}</td>
            <td>{{ if .Disponivel }} Sim {{ else }} Não {{ end }}</td>
            <td class="actions">
              <a class="edit-btn">Editar</a>
              <a
                href="/lojista/cupcakes/excluir/{{ .ID }}"
                class="delete"
                onclick="return confirm('Tem certeza?');"
                >Excluir</a
              >
            </td>
          </tr>
          {{ else }}
          <tr>
            <td colspan="5" class="empty-state">
              Nenhum cupcake cadastrado ainda.
            </td>
          </tr>
          {{ end }}
        </tbody>
      </table>
    </div>

    <div class="modal-overlay" id="cupcakeModal">
      <div class="modal-content">
        <button class="close-btn" id="closeModalBtn">&times;</button>
        <h2 id="modalTitle">Adicionar Novo Cupcake</h2>
        <form id="cupcakeForm" method="POST" enctype="multipart/form-data">
          <div class="form-group">
            <label for="nome">Nome</label>
            <input type="text" id="nome" name="nome" required />
          </div>
          <div class="form-group">
            <label for="descricao">Descrição</label>
            <textarea
              id="descricao"
              name="descricao"
              rows="4"
              required
            ></textarea>
          </div>
          <div class="form-group">
            <label for="preco">Preço (R$)</label>
            <input
              type="number"
              id="preco"
              name="preco"
              step="0.01"
              min="0"
              required
            />
          </div>
          <div class="form-group">
            <label for="imagem">Foto (opcional ao editar)</label>
            <input
              type="file"
              id="imagem"
              name="imagem"
              accept="image/png, image/jpeg"
            />
          </div>
          <div class="form-group checkbox-group">
            <input
              type="checkbox"
              id="disponivel"
              name="disponivel"
              value="true"
            />
            <label for="disponivel">Disponível para venda</label>
          </div>
          <div class="form-actions">
            <button type="button" id="cancelBtn" class="btn btn-secondary">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">Salvar</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        console.log("Script lojista_cupcakes.html carregado."); // Log de verificação
        const modalOverlay = document.getElementById("cupcakeModal");
        const addBtn = document.getElementById("addCupcakeBtn");
        const closeBtn = document.getElementById("closeModalBtn");
        const cancelBtn = document.getElementById("cancelBtn");
        const editBtns = document.querySelectorAll(".edit-btn");

        const form = document.getElementById("cupcakeForm");
        const modalTitle = document.getElementById("modalTitle");

        const openModal = () => {
          console.log("Abrindo modal..."); // Log
          modalOverlay.style.display = "flex";
        };
        const closeModal = () => {
          console.log("Fechando modal..."); // Log
          modalOverlay.style.display = "none";
        };

        if (addBtn) {
          console.log("Botão 'Adicionar' encontrado. Adicionando listener."); // Log
          addBtn.addEventListener("click", () => {
            console.log("Botão 'Adicionar' clicado!"); // Log
            modalTitle.textContent = "Adicionar Novo Cupcake";
            form.action = "/lojista/cupcakes/novo";
            form.reset();
            document.getElementById("imagem").required = true;
            openModal();
          });
        } else {
          console.error("Botão 'addCupcakeBtn' não encontrado!"); // Log de erro
        }

        editBtns.forEach((btn) => {
          btn.addEventListener("click", (e) => {
            console.log("Botão 'Editar' clicado!"); // Log
            e.preventDefault();

            const row = e.target.closest("tr");
            const id = row.dataset.id;
            if (!id) {
              console.error(
                "Não foi possível encontrar o data-id na linha da tabela!"
              );
              return;
            }

            modalTitle.textContent = "Editar Cupcake";
            form.action = `/lojista/cupcakes/editar/${id}`;

            form.nome.value = row.dataset.name || "";
            form.descricao.value = row.dataset.description || "";
            form.preco.value = row.dataset.price || "";
            form.disponivel.checked = row.dataset.available === "true";
            document.getElementById("imagem").required = false;
            document.getElementById("imagem").value = ""; // Limpa seleção de arquivo anterior

            openModal();
          });
        });

        if (closeBtn) closeBtn.addEventListener("click", closeModal);
        if (cancelBtn) cancelBtn.addEventListener("click", closeModal);
        if (modalOverlay)
          modalOverlay.addEventListener("click", (e) => {
            if (e.target === modalOverlay) closeModal();
          });
      });
    </script>
  </body>
</html>
